<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Cartos: Interactive Geo-Political Maps (India)</title>

    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap-responsive.css"/>
    <link rel="stylesheet" type="text/css" href="vendor/colorpicker/colorpicker.css" />

    <!-- Webfonts -->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- Less stylesheets -->
    <link rel="stylesheet/less" type="text/css" href="assets/css/base.less"/>

    <!-- Shortcut icon -->
    <link rel="shortcut icon" href="assets/images/favicon.png"/>

    <script src="vendor/less-1.3.3.min.js"></script>
    <script src="vendor/jquery.js"></script>
    <script src="vendor/bootstrap/bootstrap.js"></script>
  </head>
  <body>
    <div class="row full-height">
      <div id="svg-container" class="span8">
      </div>
      <div class="span4 sidebar">
          <div class="header span4">
            <span class="wrapper">
              <button id="color-begin" class="colorpicker-trigger">Start</button>
              <button id="color-end" class="colorpicker-trigger">End</button>
            </span>
          </div>
          <div id="state-values" class="main">
          </div>
          <div class="text-center footer span4">
            <span class="wrapper">
              <button id="draw">Draw</button>
              <input type="reset" id="reset"/>
            </span>
          </div>
      </div>
    </div>

    <script src="vendor/underscore.js"></script>
    <script src="vendor/require.js"></script>
    <script>
      function init(Map, inventory, interpolate) {
        var svg_elem = document.createElement('object')
        svg_elem.data = 'assets/images/map-inkscape.svg';
        svg_elem.type = 'image/svg+xml';

        svg_elem.onload = function() {
          var svg_doc = svg_elem.contentDocument,
              m = new Map(svg_doc);

          /* The meat of the code must lie here */

          // Assign a listener to the submit button
          document.getElementById('draw').onclick = function () {
            var specifier = {};
            _.each(inventory.states, function(state) {
              var val = document.getElementById(state).value;

              if ( ! isNaN(parseFloat(val)) ){
                val = interpolate(parseFloat(val));
              }

              if (val != '') {
                specifier[state] = val;
              }
            });
            
            m.paint(specifier);
          };

          // Provide the initial accent colours for the map. Random colours
          // from a scale.
          var specifier = {};
          _.each(inventory.states, function(state) {
            var value = Math.round(Math.random() * 100) / 100 ;

            specifier[state] = interpolate(value, [255,120,120], [120, 120, 255]);
            document.getElementById(state).value = value;
          });

          m.paint(specifier);
        };

        document.getElementById('svg-container').appendChild(svg_elem);
      };

      function createStateBoxes(inventory) {
        var ul = document.createElement('ul');

        _.each(_.zip(inventory.states, inventory.human_states), function(state_block) {
          var li = document.createElement('li')
          , tb = document.createElement('input')
          , sp = document.createElement('span')
          , lb = document.createElement('label');

          tb['type'] = 'text';
          tb['class'] = 'state-value';
          tb['id'] = state_block[0];
          tb['name'] = state_block[0];

          lb.htmlFor = state_block[0];

          sp.innerText = state_block[1];
          sp.textContent = state_block[1];

          li.appendChild(tb);
          li.appendChild(sp);

          lb.appendChild(li);

          ul.appendChild(lb);
        });

        document.getElementById('state-values').appendChild(ul);
      };

      function colorInputInitialize($) {
        var begin = $('button#color-begin'),
            end   = $('button#color-end'),
            b_color = '#0099ff',
            e_color = '#99ff00';

        $(begin).attr('data-color', b_color);
        $(begin).css('background-color', b_color);
        $(begin).colorpicker().on('changeColor', function(ev) {
          $(this).css('background-color', ev.color.toHex());
        });

        $(end).attr('data-color', e_color);
        $(end).css('background-color', e_color);
        $(end).colorpicker().on('changeColor', function(ev) {
          $(this).css('background-color', ev.color.toHex());
        });
      };

      requirejs.config({
        baseUrl: 'static/javascript/',
        paths: {
          'jquery': "../../vendor/require-jquery",
          'jquery.colorpicker': "../../vendor/colorpicker/bootstrap-colorpicker"
        }
      });

      $('document').ready(function() {
        requirejs(['map', 'inventory', 'interpolate'], init);
        requirejs(['inventory'], createStateBoxes);
        requirejs(['jquery', 'jquery.colorpicker'], colorInputInitialize);
      });
    </script>

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-40620026-1', 'dmulog.in');
      ga('send', 'pageview');
    </script>
  </body>
</html>
